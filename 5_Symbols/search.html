<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search — Qdrant Second Brain</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --yellow: #d29922;
      --red: #f85149;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      line-height: 1.6;
    }

    nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    nav .brand { font-weight: 700; color: var(--accent); font-size: 1.1rem; text-decoration: none; }
    nav a {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.9rem;
      padding: 4px 10px;
      border-radius: 6px;
      transition: background 0.2s, color 0.2s;
    }
    nav a:hover, nav a.active { background: var(--bg); color: var(--accent); }

    .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }

    header { border-bottom: 1px solid var(--border); padding-bottom: 1.5rem; margin-bottom: 2rem; }
    header h1 { font-size: 2rem; color: var(--accent); }
    header p  { color: var(--muted); margin-top: 0.5rem; }

    .status-bar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); flex-shrink: 0; }
    .status-dot.ok   { background: var(--green); }
    .status-dot.load { background: var(--yellow); animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    .settings {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      align-items: center;
      font-size: 0.85rem;
    }
    .settings label { color: var(--muted); margin-right: 6px; }
    .settings select, .settings input[type="number"] {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      padding: 4px 8px;
      font-size: 0.85rem;
    }

    .search-box { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
    .search-box input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      padding: 12px 16px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-box input:focus { border-color: var(--accent); }
    .search-box button {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .search-box button:hover:not(:disabled) { opacity: 0.85; }
    .search-box button:disabled { opacity: 0.5; cursor: not-allowed; }

    .chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
    .chip {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 14px;
      font-size: 0.8rem;
      color: var(--muted);
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .chip:hover { border-color: var(--accent); color: var(--accent); }

    #results { min-height: 200px; }
    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      transition: border-color 0.2s;
    }
    .result-card:hover { border-color: var(--accent); }
    .result-card .title { font-weight: 600; color: var(--accent); font-size: 0.95rem; }
    .result-card .path  { font-size: 0.8rem; color: var(--muted); margin-top: 2px; word-break: break-all; }
    .result-card .score {
      display: inline-block;
      margin-top: 6px;
      background: var(--bg);
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 0.75rem;
      color: var(--green);
    }

    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--muted); }
    .empty-state .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

    .error-box {
      background: rgba(248,81,73,0.1);
      border: 1px solid var(--red);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      color: var(--red);
    }
    .error-box a { color: var(--accent); }

    .spinner {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .meta { font-size: 0.8rem; color: var(--muted); margin-bottom: 1rem; }

    footer { border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 2rem; font-size: 0.8rem; color: var(--muted); text-align: center; }
    footer a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>

  <nav>
    <a href="../index.html" class="brand">Qdrant</a>
    <a href="../index.html">Home</a>
    <a href="search.html" class="active">Search</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="../index.html#testing">Validation</a>
  </nav>

  <div class="container">

    <header>
      <h1>Semantic Search</h1>
      <p>Search your second brain using vector similarity — Qdrant at <code>192.168.2.227:6333</code></p>
    </header>

    <!-- Status bar -->
    <div class="status-bar">
      <span class="status-dot load" id="qdrant-dot"></span>
      <span id="qdrant-status">Checking Qdrant…</span>
      <span style="margin-left:auto;display:flex;align-items:center;gap:6px;">
        <span class="spinner" id="model-spinner"></span>
        <span id="model-status">Loading model…</span>
      </span>
    </div>

    <!-- Model error box (hidden until needed) -->
    <div id="model-error" class="error-box" style="display:none"></div>

    <!-- Settings -->
    <div class="settings">
      <div>
        <label for="collection-select">Collection:</label>
        <select id="collection-select">
          <option value="mac_repo_index">mac_repo_index</option>
        </select>
      </div>
      <div>
        <label for="limit-input">Results:</label>
        <input type="number" id="limit-input" value="10" min="1" max="50" style="width:60px" />
      </div>
    </div>

    <!-- Search input -->
    <div class="search-box">
      <input type="text" id="search-query" placeholder="Ask anything about your notes…" autofocus
             onkeydown="if(event.key==='Enter') window.performSearch()" />
      <button id="search-btn" onclick="window.performSearch()" disabled>Search</button>
    </div>

    <!-- Quick picks -->
    <div class="chips">
      <span class="chip" onclick="setQuery('How to set up Qdrant on Proxmox')">Qdrant setup</span>
      <span class="chip" onclick="setQuery('Docker container configuration')">Docker config</span>
      <span class="chip" onclick="setQuery('Python embedding pipeline')">Embeddings</span>
      <span class="chip" onclick="setQuery('git version control workflow')">Git workflow</span>
      <span class="chip" onclick="setQuery('kubernetes deployment')">Kubernetes</span>
    </div>

    <div id="results">
      <div class="empty-state">
        <div class="icon">&#128269;</div>
        <p>Type a query above to search your second brain</p>
      </div>
    </div>

    <footer>
      Qdrant &mdash; Second Brain Semantic Search &bull;
      <a href="https://qdrant.tech/documentation/">Qdrant Docs</a> &bull;
      <a href="../index.html">Back to Home</a>
    </footer>

  </div>

<!-- ES module: the ONLY correct way to use @xenova/transformers -->
<script type="module">
  import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';

  // Prevent Transformers.js from trying to load local models
  env.allowLocalModels = false;

  const QDRANT = 'http://192.168.2.227:6333';
  let   extractor = null;

  // ── helpers ──────────────────────────────────────────────────────────────

  function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  async function qdrantQuery(collection, vector, limit) {
    const res = await fetch(`${QDRANT}/collections/${collection}/points/query`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: vector, limit, with_payload: true })
    });
    if (!res.ok) throw new Error(`Qdrant returned HTTP ${res.status}`);
    const json = await res.json();
    // qdrant-client ≥1.10 wraps in .points; older returns bare array
    return json.result?.points ?? json.result ?? [];
  }

  // ── Qdrant health + collections ─────────────────────────────────────────

  async function checkQdrant() {
    const dot = document.getElementById('qdrant-dot');
    const txt = document.getElementById('qdrant-status');
    try {
      const r = await fetch(`${QDRANT}/healthz`, { signal: AbortSignal.timeout(4000) });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      dot.className = 'status-dot ok';
      txt.textContent = 'Qdrant connected';

      const cols = await fetch(`${QDRANT}/collections`).then(r => r.json());
      const sel  = document.getElementById('collection-select');
      const list = cols.result?.collections ?? [];
      if (list.length) {
        sel.innerHTML = '';
        list.forEach(c => {
          const opt = document.createElement('option');
          opt.value = opt.textContent = c.name;
          if (c.name === 'mac_repo_index') opt.selected = true;
          sel.appendChild(opt);
        });
      }
    } catch (e) {
      dot.className = 'status-dot';
      txt.textContent = `Qdrant unreachable — ${e.message}`;
    }
  }

  // ── Model load ───────────────────────────────────────────────────────────

  async function initModel() {
    const statusEl  = document.getElementById('model-status');
    const spinnerEl = document.getElementById('model-spinner');
    const errorEl   = document.getElementById('model-error');

    try {
      statusEl.textContent = 'Downloading all-MiniLM-L6-v2…';
      extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
      spinnerEl.style.display = 'none';
      statusEl.textContent    = 'Model ready';
      statusEl.style.color    = 'var(--green)';
      document.getElementById('search-btn').disabled = false;
    } catch (e) {
      spinnerEl.style.display = 'none';
      statusEl.textContent    = 'Model failed to load';
      statusEl.style.color    = 'var(--red)';
      errorEl.style.display   = 'block';
      errorEl.innerHTML = `
        <strong>Model failed to load</strong> — ${escapeHtml(e.message)}<br><br>
        Common causes &amp; fixes (see also
        <a href="../index.html#semblance">6_Semblance</a>):<br>
        &bull; <strong>Script tag instead of module import</strong> — <code>&lt;script src=&gt;</code>
          does not expose <code>pipeline</code> as a global; must use
          <code>&lt;script type="module"&gt; import { pipeline } from '…'</code><br>
        &bull; <strong>Mixed content</strong> — if the page is served over HTTPS, the browser
          blocks fetches to the HuggingFace CDN over HTTP. Open via
          <code>file://</code> or <code>http://localhost</code>.<br>
        &bull; <strong>No internet</strong> — model weights (~90 MB) are fetched from HuggingFace
          on first load. Check network connectivity.<br>
        &bull; <strong>CSP header</strong> — some servers add a Content-Security-Policy that
          blocks <code>connect-src</code> to external origins.
      `;
    }
  }

  // ── Search ───────────────────────────────────────────────────────────────

  window.setQuery = function (term) {
    document.getElementById('search-query').value = term;
    document.getElementById('search-query').focus();
  };

  window.performSearch = async function () {
    const query      = document.getElementById('search-query').value.trim();
    const collection = document.getElementById('collection-select').value;
    const limit      = parseInt(document.getElementById('limit-input').value) || 10;
    const resultsDiv = document.getElementById('results');

    if (!query || !extractor) return;

    resultsDiv.innerHTML = '<div class="empty-state"><span class="spinner" style="width:24px;height:24px;border-width:3px;"></span><p style="margin-top:12px">Searching…</p></div>';

    try {
      const t0     = performance.now();
      const output = await extractor(query, { pooling: 'mean', normalize: true });
      const vector = Array.from(output.data);
      const points = await qdrantQuery(collection, vector, limit);
      const ms     = (performance.now() - t0).toFixed(0);

      if (!points.length) {
        resultsDiv.innerHTML = '<div class="empty-state"><div class="icon">&#128528;</div><p>No results found</p></div>';
        return;
      }

      resultsDiv.innerHTML = `<p class="meta">${points.length} results &mdash; ${ms}ms</p>`;
      points.forEach(r => {
        const card = document.createElement('div');
        card.className = 'result-card';
        card.innerHTML = `
          <div class="title">${escapeHtml(r.payload?.filename ?? r.payload?.title ?? 'Untitled')}</div>
          ${r.payload?.path ? `<div class="path">${escapeHtml(r.payload.path)}</div>` : ''}
          <span class="score">Score: ${r.score.toFixed(4)}</span>`;
        resultsDiv.appendChild(card);
      });
    } catch (err) {
      resultsDiv.innerHTML = `<div class="empty-state"><div class="icon">&#9888;&#65039;</div><p>Error: ${escapeHtml(err.message)}</p></div>`;
    }
  };

  // ── Boot ─────────────────────────────────────────────────────────────────
  checkQdrant();
  initModel();
</script>

</body>
</html>
